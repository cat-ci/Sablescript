<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Notepad++-Style Editor with Auto-Close and Autocomplete</title>

  <!-- CodeMirror core CSS -->
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.7/codemirror.min.css"
  />
  <!-- Theme (pick any) -->
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.7/theme/eclipse.min.css"
  />

  <!-- Show-Hint CSS for autocomplete suggestions -->
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.7/addon/hint/show-hint.min.css"
  />

  <style>
    /* Basic Reset */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: Arial, sans-serif;
    }
    html, body {
      height: 100%;
      background: #f0f0f0;
    }
    body {
      display: flex; /* sidebar + main section side by side */
      flex-direction: row;
    }

    /* --- SIDEBAR --- */
    .sidebar {
      width: 200px;
      background-color: #fafafa;
      border-right: 1px solid #ccc;
      display: flex;
      flex-direction: column;
      justify-content: space-between; /* top content + bottom content */
    }

    /* Top portion of sidebar (search, buttons, tabs) */
    .sidebar-top {
      display: flex;
      flex-direction: column;
      padding: 8px;
    }

    /* Search bar at the top of sidebar */
    .sidebar-search {
      margin-bottom: 8px;
    }
    .sidebar-search input {
      width: 100%;
      padding: 4px 6px;
      border: 1px solid #ccc;
      border-radius: 3px;
    }

    /* "New" button (full width) */
    #btnNew {
      width: 100%;
      margin-bottom: 8px;
      background-color: #fff;
      border: 1px solid #ccc;
      border-radius: 3px;
      padding: 6px;
      cursor: pointer;
    }
    #btnNew:hover {
      background-color: #e9e9e9;
    }

    /* Row with Load/Save (each half width) */
    .load-save-row {
      display: flex;
      flex-direction: row;
      margin-bottom: 8px;
    }
    .load-save-row button {
      flex: 1;
      margin-right: 4px;
      background-color: #fff;
      border: 1px solid #ccc;
      border-radius: 3px;
      padding: 6px;
      cursor: pointer;
    }
    .load-save-row button:last-child {
      margin-right: 0;
    }
    .load-save-row button:hover {
      background-color: #e9e9e9;
    }

    /* Tabs container */
    .tabs-container {
      background-color: #fff;
      border: 1px solid #ccc;
      min-height: 100px; /* ensures some space for demonstration */
      border-radius: 3px;
      overflow-y: auto;
      padding: 4px;
    }
    .tab-item {
      position: relative; /* for the close button positioning */
      padding: 4px 6px;
      margin-bottom: 4px;
      border: 1px solid #ccc;
      border-radius: 3px;
      cursor: pointer;
      background-color: #f9f9f9;
      color: #333;
      user-select: none;
    }
    .tab-item:hover {
      background-color: #e2e2e2;
    }
    .tab-item.active {
      background-color: #c9e2ff;
      border-color: #66aaff;
    }

    /* Tab title text */
    .tab-title {
      display: inline-block;
    }

    /* Tab rename input (hidden by default) */
    .tab-rename-input {
      display: none;
      width: calc(100% - 26px); /* account for close button space */
      border: 1px solid #ccc;
      border-radius: 3px;
      padding: 2px 4px;
    }

    /* The close button (X) */
    .tab-close {
      position: absolute;
      right: 4px;
      top: 4px;
      display: none; /* only show on hover */
      cursor: pointer;
      font-weight: bold;
      color: #777;
    }
    .tab-item:hover .tab-close {
      display: inline;
    }
    .tab-close:hover {
      color: red;
    }

    /* Bottom portion of sidebar (Extensions, Settings) */
    .sidebar-bottom {
      padding: 8px;
      display: flex;
      justify-content: space-between;
      border-top: 1px solid #ccc;
    }
    .sidebar-bottom button {
      background-color: #fff;
      border: 1px solid #ccc;
      border-radius: 3px;
      padding: 4px 6px;
      cursor: pointer;
      font-size: 12px;
    }
    .sidebar-bottom button:hover {
      background-color: #e9e9e9;
    }

    /* --- MAIN SECTION (right side) --- */
    .main-section {
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    /* Top bar (filename in center, run button right) */
    .topbar {
      display: flex;
      align-items: center;
      background-color: #f5f5f5;
      border-bottom: 1px solid #ccc;
      min-height: 40px;
      padding: 0 10px;
    }
    /* The file-info area in the center */
    .file-info {
      flex: 1;
      text-align: center; /* center the filename */
      position: relative;
      user-select: none;
    }

    /* We'll have a "label" for the base name and a hidden input for rename. */
    .filename-label {
      display: inline-block;
      padding-right: 3px; /* space before extension */
      cursor: text;
    }
    .filename-input {
      display: none; /* hidden by default, shown on double-click */
      width: 150px;
      border: 1px solid #ccc;
      border-radius: 3px;
      padding: 2px 4px;
      text-align: right;
      margin-right: 3px;
    }
    .filename-ext {
      appearance: none; 
      border: none;
      background: transparent;
      font-family: inherit;
      font-size: inherit;
      cursor: pointer;
    }
    .filename-ext option {
      color: #333;
    }

    /* Run button (far right) */
    .topbar button {
      background-color: #fff;
      border: 1px solid #ccc;
      border-radius: 3px;
      padding: 6px 12px;
      cursor: pointer;
    }
    .topbar button:hover {
      background-color: #e9e9e9;
    }

    /* Editor container */
    .editor-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    .CodeMirror {
      flex: 1;
      height: 100%;
    }

    /* Status bar */
    .status-bar {
      height: 24px;
      background-color: #e0e0e0;
      border-top: 1px solid #ccc;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 10px;
      font-size: 13px;
    }
  </style>
</head>

<body>

  <!-- SIDEBAR -->
  <div class="sidebar">
    <div class="sidebar-top">
      <!-- Search bar -->
      <div class="sidebar-search">
        <input type="search" placeholder="Search..." />
      </div>

      <!-- "New" button (full width) -->
      <button id="btnNew">New</button>

      <!-- Load/Save row -->
      <div class="load-save-row">
        <button id="btnLoad">Load</button>
        <button id="btnSave">Save</button>
      </div>

      <!-- Tabs list -->
      <div class="tabs-container" id="tabsContainer">
        <!-- Dynamically populated with open file tabs -->
      </div>
    </div>

    <div class="sidebar-bottom">
      <button id="btnExtensions">Ext</button>
      <button id="btnSettings">Settings</button>
    </div>
  </div>

  <!-- MAIN SECTION (top bar + editor + status bar) -->
  <div class="main-section">

    <!-- Top bar -->
    <div class="topbar">
      <div class="file-info">
        <!-- Label (double-click to rename) -->
        <span class="filename-label" id="filenameBaseLabel">untitled</span>
        <!-- Input (hidden by default, for renaming) -->
        <input
          type="text"
          class="filename-input"
          id="filenameBaseInput"
          value="untitled"
        />
        <!-- Extension dropdown (styled like text) -->
        <select id="filenameExt" class="filename-ext">
          <option value="txt">.txt</option>
          <option value="html">.html</option>
          <option value="css">.css</option>
          <option value="js">.js</option>
          <option value="py">.py</option>
          <option value="php">.php</option>
        </select>
      </div>
      <button id="btnRun">Run</button>
    </div>

    <!-- Editor area -->
    <div class="editor-container">
      <textarea id="codeEditor"></textarea>
    </div>

    <!-- Status bar -->
    <div class="status-bar">
      <div id="statusText">Line 1, Col 1</div>
      <div id="statusEncoding">UTF-8 | Windows (CR LF)</div>
    </div>
  </div>

  <!-- Hidden file input for loading local files -->
  <input
    type="file"
    id="fileInput"
    accept=".txt,.html,.css,.js,.json,.md,.xml,.c,.cpp,.java,.py"
    style="display: none"
  />

  <!-- CodeMirror core JS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.7/codemirror.min.js"></script>
  <!-- Language modes -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.7/mode/javascript/javascript.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.7/mode/css/css.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.7/mode/htmlmixed/htmlmixed.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.7/mode/xml/xml.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.7/mode/clike/clike.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.7/mode/php/php.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.7/mode/python/python.min.js"></script>

  <!-- ADDONS for Autocomplete & Auto-Close -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.7/addon/edit/closetag.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.7/addon/hint/show-hint.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.7/addon/hint/xml-hint.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.7/addon/hint/html-hint.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.7/addon/hint/css-hint.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.7/addon/hint/javascript-hint.min.js"></script>
  <!-- Optionally, anyword-hint or others if you want general word completions -->
  <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.7/addon/hint/anyword-hint.min.js"></script> -->

  <script>
    /************************************************************
     *             MULTI-TAB DATA STRUCTURE & LOGIC
     ************************************************************/
    let tabs = [];
    let currentTabId = null;

    function getModeFromExtension(ext) {
      switch (ext) {
        case 'html': return 'htmlmixed';
        case 'css':  return 'css';
        case 'js':   return 'javascript';
        case 'py':   return 'python';
        case 'php':  return 'php';
        case 'c':
        case 'cpp':
        case 'java': return 'text/x-c++src';
        default:     return 'plaintext';
      }
    }

    function createNewTab(baseName = 'untitled', extension = 'txt', content = '') {
      const newId = Date.now(); // simple unique ID
      tabs.push({ id: newId, name: baseName, extension, content });
      return newId;
    }

    function renderTabs() {
      const tabsContainer = document.getElementById('tabsContainer');
      tabsContainer.innerHTML = '';

      tabs.forEach((tab) => {
        const tabEl = document.createElement('div');
        tabEl.className = 'tab-item' + (tab.id === currentTabId ? ' active' : '');
        tabEl.setAttribute('data-id', tab.id);

        // Title span
        const titleSpan = document.createElement('span');
        titleSpan.className = 'tab-title';
        titleSpan.textContent = tab.name + '.' + tab.extension;
        tabEl.appendChild(titleSpan);

        // Hidden input for rename
        const renameInput = document.createElement('input');
        renameInput.type = 'text';
        renameInput.className = 'tab-rename-input';
        renameInput.value = tab.name;
        tabEl.appendChild(renameInput);

        // Close button (X)
        const closeSpan = document.createElement('span');
        closeSpan.className = 'tab-close';
        closeSpan.textContent = 'x';
        tabEl.appendChild(closeSpan);

        // Switch tab on single-click
        tabEl.addEventListener('click', (e) => {
          if (e.target === closeSpan) return; // avoid switching if closing
          switchToTab(tab.id);
        });
        // Rename on double-click
        titleSpan.addEventListener('dblclick', (e) => {
          e.stopPropagation();
          startTabRename(tab.id, tabEl);
        });
        // Close on X
        closeSpan.addEventListener('click', (e) => {
          e.stopPropagation();
          closeTab(tab.id);
        });

        // Rename input events
        renameInput.addEventListener('blur', () => {
          finishTabRename(tab.id, renameInput.value);
        });
        renameInput.addEventListener('keydown', (evt) => {
          if (evt.key === 'Enter') {
            evt.preventDefault();
            finishTabRename(tab.id, renameInput.value);
          }
        });

        tabsContainer.appendChild(tabEl);
      });
    }

    function startTabRename(tabId, tabEl) {
      const titleSpan = tabEl.querySelector('.tab-title');
      const renameInput = tabEl.querySelector('.tab-rename-input');
      titleSpan.style.display = 'none';
      renameInput.style.display = 'inline-block';
      renameInput.focus();
      renameInput.select();
    }

    function finishTabRename(tabId, newName) {
      const tab = tabs.find(t => t.id === tabId);
      if (!tab) return;
      newName = newName.trim() || 'untitled';
      tab.name = newName;
      renderTabs();
      // If the renamed tab is the current one, update top bar label
      if (tabId === currentTabId) {
        filenameBaseLabel.textContent = tab.name;
        filenameBaseInput.value = tab.name;
      }
    }

    function closeTab(tabId) {
      const index = tabs.findIndex(t => t.id === tabId);
      if (index === -1) return;
      tabs.splice(index, 1);

      if (tabId === currentTabId) {
        // Switch to another tab if any left
        if (tabs.length > 0) {
          switchToTab(tabs[tabs.length - 1].id);
        } else {
          // No tabs -> create a blank new one
          currentTabId = null;
          const newTabId = createNewTab();
          switchToTab(newTabId);
        }
      } else {
        renderTabs();
      }
    }

    function switchToTab(tabId) {
      // Save current tab's content first
      if (currentTabId !== null) {
        const currentTab = tabs.find(t => t.id === currentTabId);
        if (currentTab) {
          currentTab.content = editor.getValue();
          currentTab.name = filenameBaseInput.value.trim() || 'untitled';
          currentTab.extension = filenameExt.value;
        }
      }
      currentTabId = tabId;
      const newTab = tabs.find(t => t.id === currentTabId);
      if (!newTab) return;

      editor.setValue(newTab.content || '');
      editor.setOption('mode', getModeFromExtension(newTab.extension));
      filenameBaseLabel.textContent = newTab.name;
      filenameBaseInput.value = newTab.name;
      filenameExt.value = newTab.extension;

      renderTabs();
    }

    /************************************************************
     *                    CODEMIRROR SETUP
     ************************************************************/
    const editor = CodeMirror.fromTextArea(document.getElementById('codeEditor'), {
      lineNumbers: true,
      mode: 'plaintext',
      theme: 'eclipse',
      tabSize: 2,
      indentUnit: 2,
      // AUTO-CLOSING TAGS
      autoCloseTags: true, 
      // For bracket pairs (optional): autoCloseBrackets: true, // if you load "addon/edit/closebrackets.js"
      // AUTOCOMPLETE:
      extraKeys: {
        // Trigger autocomplete manually
        'Ctrl-Space': 'autocomplete',
        // Make Tab accept the autocomplete suggestion if one is active,
        // otherwise insert a normal tab character:
        'Tab': function(cm) {
          let completion = cm.state.completionActive;
          if (completion) {
            completion.widget.pick();
          } else {
            cm.replaceSelection('\t');
          }
        }
      }
    });

    // Show suggestions automatically on user input
    editor.on('inputRead', function(cm, change) {
      // If it's a single character insertion (not a delete, paste, etc.)
      if (change.text && change.text[0].length === 1) {
        CodeMirror.commands.autocomplete(cm, null, { completeSingle: false });
      }
    });

    // Status bar: update line/col
    const statusText = document.getElementById('statusText');
    editor.on('cursorActivity', function() {
      const pos = editor.getCursor();
      statusText.textContent = `Line ${pos.line + 1}, Col ${pos.ch + 1}`;
    });

    /************************************************************
     *                  UI ELEMENTS REFERENCES
     ************************************************************/
    const btnNew = document.getElementById('btnNew');
    const btnLoad = document.getElementById('btnLoad');
    const btnSave = document.getElementById('btnSave');
    const btnRun = document.getElementById('btnRun');
    const fileInput = document.getElementById('fileInput');

    const filenameBaseLabel = document.getElementById('filenameBaseLabel');
    const filenameBaseInput = document.getElementById('filenameBaseInput');
    const filenameExt = document.getElementById('filenameExt');

    /************************************************************
     *        RENAME LOGIC (TOP BAR) - double-click label
     ************************************************************/
    filenameBaseLabel.addEventListener('dblclick', () => {
      filenameBaseLabel.style.display = 'none';
      filenameBaseInput.style.display = 'inline-block';
      filenameBaseInput.focus();
      filenameBaseInput.select();
    });
    filenameBaseInput.addEventListener('blur', () => {
      applyTopBarRename();
    });
    filenameBaseInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        applyTopBarRename();
      }
    });
    function applyTopBarRename() {
      const newName = filenameBaseInput.value.trim() || 'untitled';
      filenameBaseLabel.textContent = newName;
      filenameBaseInput.style.display = 'none';
      filenameBaseLabel.style.display = 'inline-block';
      if (currentTabId !== null) {
        const tab = tabs.find(t => t.id === currentTabId);
        if (tab) {
          tab.name = newName;
          renderTabs(); 
        }
      }
    }

    // On extension change, update the mode + tab data
    filenameExt.addEventListener('change', () => {
      if (currentTabId === null) return;
      const currentTab = tabs.find(t => t.id === currentTabId);
      if (currentTab) {
        currentTab.extension = filenameExt.value;
        editor.setOption('mode', getModeFromExtension(currentTab.extension));
        renderTabs();
      }
    });

    /************************************************************
     *                    BUTTON HANDLERS
     ************************************************************/
    function createAndSwitchToNewTab() {
      const newTabId = createNewTab();
      switchToTab(newTabId);
    }

    // NEW
    btnNew.addEventListener('click', createAndSwitchToNewTab);

    // LOAD
    btnLoad.addEventListener('click', () => {
      fileInput.click();
    });
    fileInput.addEventListener('change', function() {
      const file = this.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (e) => {
        const parts = file.name.split('.');
        const baseName = parts.slice(0, -1).join('.') || 'untitled';
        const extension = parts.slice(-1)[0] || 'txt';
        const newTabId = createNewTab(baseName, extension, e.target.result);
        switchToTab(newTabId);
      };
      reader.readAsText(file);
      this.value = ''; // reset for next open
    });

    // SAVE
    btnSave.addEventListener('click', saveFile);
    function saveFile() {
      if (currentTabId === null) return;
      const tab = tabs.find(t => t.id === currentTabId);
      if (!tab) return;
      tab.content = editor.getValue();
      tab.name = filenameBaseInput.value.trim() || 'untitled';
      tab.extension = filenameExt.value;

      const textToSave = tab.content;
      const blob = new Blob([textToSave], { type: 'text/plain' });
      const filename = `${tab.name}.${tab.extension}`;

      const tempLink = document.createElement('a');
      tempLink.href = URL.createObjectURL(blob);
      tempLink.download = filename;
      tempLink.click();
      URL.revokeObjectURL(tempLink.href);
    }

    // RUN
    btnRun.addEventListener("click", function() {
  var codeContent = editor.getValue();

  // Open a new mini window (e.g., 600x400)
  var newWindow = window.open("", "miniWindow", "width=600,height=400,resizable=yes");

  if (newWindow) {
    newWindow.document.write(codeContent);
    newWindow.document.close();
  } else {
    alert("Popup blocked! Please allow pop-ups for this site.");
  }
});


    /************************************************************
     *   KEYBOARD SHORTCUTS (Ctrl+S, Ctrl+O, Ctrl+N) 
     ************************************************************/
    document.addEventListener('keydown', (e) => {
      if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 's') {
        e.preventDefault();
        saveFile();
      } else if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'o') {
        e.preventDefault();
        fileInput.click();
      } else if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'n') {
        e.preventDefault();
        createAndSwitchToNewTab();
      }
    });

    /************************************************************
     *          INIT: Create an initial tab and display it
     ************************************************************/
    (function init() {
      const initialTabId = createNewTab('untitled', 'txt', '');
      switchToTab(initialTabId);
    })();
  </script>
</body>
</html>
